{% extends "base.html" %}
{% block title%}
ai-beats
{% endblock %}

{% block head %}
<meta name="description" content="">
<!--本番時はmin版にする-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js"></script>
<script src="https://code.createjs.com/1.0.0/soundjs.min.js"></script>
{% load static %}
<script src="{% static 'aiBeats/JavaScript/jquery.knob.min.js' %}"></script>

<style>
    body {
        margin: 0;
        overflow: hidden;
    }
</style>
{% load static %}

{% endblock %}

{% block content %}
<div id="wrap" style="position: relative;touch-action: manipulation;">
    <canvas id="myCanvas" style="position: absolute;"></canvas>
    <canvas id="judge" style="position: absolute;pointer-events: none;width:200px;height:100px;"></canvas>
    <canvas id="info"
        style="position: absolute;pointer-events: none;width:300px;height:300px;right:0px;top:30px;"></canvas>
    <button type="button" class="fullScreen btn far fa-square" style="display: block;position: absolute;color: white;"
        onClick="fullScreen();"></button>
    <div class="btn-group dropleft" style="display: block;position: absolute;right: 0px;">
        <button type="button" id="dropleft" class="dropleft btn fas fa-pause" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false" style="color: white;" onClick="pause();"></button>
        <div class="dropdown-menu" x-placement="left-start"
            style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-196px, 0px, 0px);">
            <a class="dropdown-item" href="#" onClick="restart();">Restart</a>
            <a class="dropdown-item" href="/ai-beats">Music Select</a>
            <div class="dropdown-divider"></div>
            <div class="volume d-flex justify-content-center">
                <p>Volume:</p>
                <input type="text" class="volumeDial" value="100" />
            </div>
        </div>
    </div>
    <button id="playButton" type="button" class="btn btn-primary"
        style="display: block;position: absolute;top:480px; left: 270px;" onClick="sound_play();">Play</button>
</div>
<script>
    var sound, backGround, tja, leftSE, rightSE;
    onload = function () {
        $(".volumeDial").knob({ //音量調整ダイアルの設定
            angleOffset: 240,
            angleArc: 240,
            width: 100,
            height: 100,
            release: function (v) {
                sound.changeVolume(v);
                leftSE.changeVolume(v);
                rightSE.changeVolume(v);
            }
        });
        $("#myCanvas").on("click", function (e) { //ドロップダウンメニューが消えないようにする
            e.stopPropagation();
        });
        $(".navbar").on("click", function (e) { //ドロップダウンメニューが消えないようにする
            e.stopPropagation();
        });
        $(".dropdown-menu").on("click", function (e) { //ドロップダウンメニューが消えないようにする
            e.stopPropagation();
        });
        $(".fullScreen").on("click", function (e) { //ドロップダウンメニューが消えないようにする
            e.stopPropagation();
        });
        sound = new Sound("sound", "{% static 'aiBeats/music/バンバード ～Piano Version～.ogg' %}");
        leftSE = new SE("left", "{% static 'aiBeats/SE/left2.ogg' %}"); //from 魔王魂様
        rightSE = new SE("right", "{% static 'aiBeats/SE/right1.ogg' %}"); //from 魔王魂様
        backGround = new BackGround();
        tja = new TJA("{% static 'aiBeats/tja/バンバード ~Piano Version~.tja' %}");
        window.addEventListener('resize', onResize);
        var canvas = document.getElementById("myCanvas");
        canvas.addEventListener('click', function (e) {
            var button = e.target.getBoundingClientRect();
            var mouseX = e.clientX - button.left;
            var mouseY = e.clientY - button.top;
            if (mouseX < backGround.width / 2) {
                backGround.leftTouch();
            } else {
                backGround.rightTouch();
            }
        }, false);
        canvas.addEventListener('touchstart', function (e) {
            e.preventDefault(); // デフォルトイベントをキャンセル
            for (var i = 0; i < e.touches.length; i++) {
                console.log(e.touches[i]);
                if (e.touches[i].pageX < backGround.width / 2) {
                    backGround.leftTouch();
                } else {
                    backGround.rightTouch();
                }
            }
        }, false);
        var judgeCanvas = document.getElementById("judge");
        judgeCanvas.style.top = backGround.height * 3 / 4 + "px";
        judgeCanvas.style.left = backGround.width / 2 + "px";

        var infoCanvas = document.getElementById("info");
        var infoCtx = infoCanvas.getContext("2d");
        //infoCtx.clearRect(0, 0, 200, 100);
        infoCtx.font = "20px 'ＭＳ Ｐゴシック'";
        infoCtx.fillStyle = "white";
        infoCtx.fillText("バンバード ～Piano Version～", 0, 20);
    }

    document.onkeydown = keydown;

    function keydown(event) {
        if (event.key == "f" || event.key == "d" || event.key == "s" || event.key == "a") {
            backGround.leftTouch();
        } else if (event.key == "j" || event.key == "k" || event.key == "l" || event.key == ";") {
            backGround.rightTouch();
        }
    }

    function onResize() {
        var preWidth = backGround.width;
        var preHeight = backGround.height;
        // サイズを取得
        const width = window.innerWidth;
        const height = window.innerHeight;
        console.log(width, height);
        backGround.width = width;
        backGround.height = height;

        var judgeCanvas = document.getElementById("judge");
        judgeCanvas.style.top = backGround.height * 3 / 4 + "px";
        judgeCanvas.style.left = backGround.width / 2 + "px";

        // レンダラーのサイズを調整する
        backGround.renderer.setPixelRatio(window.devicePixelRatio);
        backGround.renderer.setSize(width, height);

        // カメラのアスペクト比を正す
        backGround.camera.aspect = width / height;
        backGround.camera.updateProjectionMatrix();


        backGround.splineObject.position.x = -backGround.width / 2;
        backGround.splineObject.position.y = -backGround.height / 2;
        backGround.leftMesh.position.x = -backGround.width / 4;
        backGround.rightMesh.position.x = backGround.width / 4;
        var MeshGeometry = new THREE.BoxBufferGeometry(backGround.width / 2, backGround.height, 1);
        backGround.leftMesh.geometry = MeshGeometry;
        backGround.rightMesh.geometry = MeshGeometry;

        backGround.torus.position.y = -backGround.height / 4;

        backGround.scoreGroup.position.y *= backGround.height / preHeight;

        backGround.textMesh.position.y = -backGround.height / 4;
        backGround.textMesh.position.x = backGround.width / 20;

        backGround.titleMesh.position.y = backGround.height / 3;
        backGround.titleMesh.position.x = -backGround.width / 2 + backGround.width / 8;

        backGround.renderer.render(backGround.scene, backGround.camera);
    }

    class TJA {
        constructor(src) {
            this.src = src;
            this.currentBar = 0;
            this.beat = [
                [-100, 4]
            ]; //拍子。[小節, 4分の何拍子か]
            this.bpm = [];
            this.delay = []; //遅延挿入。[小節, 遅延秒数, 未使用は1使用したら0,]
            this.judgeList = []; //判定用のリスト。[何個目の円か, Three.Meshオブジェクト, 譜面上の数字, 秒数]
            $.ajax({
                url: this.src,
                success: function (data) {
                    tja.title = data.match(/TITLE:.*\r?\n/)[0].slice(6).replace(/\r?\n/g, "");
                    var loader = new THREE.FontLoader();
                    loader.load("{% static 'aiBeats/typeface/07YasashisaGothic_Regular.json' %}",
                        function (font) {
                            var titleGeometry = new THREE.TextGeometry(tja.title, {
                                font: font,
                                size: 12,
                                height: 5,
                                curveSegments: 12
                            });
                            var materials = [
                                new THREE.MeshBasicMaterial({
                                    color: 0xffffff
                                }),
                                new THREE.MeshBasicMaterial({
                                    color: 0x000000
                                })
                            ];
                            backGround.titleMesh = new THREE.Mesh(titleGeometry, materials);
                            backGround.titleMesh.position.y = backGround.height / 3;
                            backGround.titleMesh.position.x = -backGround.width / 2 + backGround
                                .width / 20;
                            backGround.scene.add(backGround.titleMesh);
                        });

                    tja.offset = Number(data.match(/OFFSET:.*\r?\n/)[0].slice(7).replace(/\r?\n/g, ""));
                    var firstBpm = Number(data.match(/BPM:.*\r?\n/)[0].slice(4).replace(/\r?\n/g, ""));
                    tja.bpm.push([-100, firstBpm]);
                    var allScore = data.match(/#START[\s\S]*#END/)[0].slice(6).slice(0, -4).split(",");
                    tja.score = [];
                    var orders;
                    var order;
                    for (var i = 0; i < allScore.length; i++) {
                        if (allScore[i].match(/./)) {
                            if (allScore[i].match(/.*#.*/)) {
                                orders = allScore[i].match(/(?:\r?\n)*#.*(?:\r?\n)+/g);
                                tja.score.push(allScore[i].replace(/(\r?\n)*#.*(\r?\n)+/g, "").replace(
                                    /\r?\n/g, ""));
                                for (var j = 0; j < orders.length; j++) {
                                    order = orders[j].replace(/(\r?\n)/g, "");
                                    if (order.match(/#MEASURE/)) {
                                        var denominator = Number(order.slice(11, 12));
                                        var numerator = Number(order.slice(9, 10));
                                        tja.beat.push([i, numerator / (denominator / 4)]);
                                    } else if (order.match(/#BPMCHANGE/)) {
                                        tja.bpm.push([i, Number(order.slice(11))]);
                                    } else if (order.match(/#DELAY/)) {
                                        tja.delay.push([i, Number(order.slice(7), 1)]);
                                    }
                                }
                            } else {
                                tja.score.push(allScore[i].replace(/\r?\n/g, ""));
                            }
                        }
                    }
                    var time = -tja.offset * 1000;
                    var beat = tja.beat[0][1];
                    var bpm = tja.bpm[0][1];
                    for (var i = 0; i < tja.score.length; i++) {
                        var bar = tja.score[i].split("");
                        for (var d = 0; d < tja.delay.length; d++) {
                            if (tja.delay[d][2] == 1 && i > tja.delay[d][0]) {
                                tja.delay[d][2] = 0;
                                time += tja.delay[d][1] * 1000;
                            }
                        }
                        for (var be = 0; be < tja.beat.length; be++) {
                            if (i > tja.beat[be][0]) {
                                beat = tja.beat[be][1];
                            }
                        }
                        for (var bp = 0; bp < tja.bpm.length; bp++) {
                            if (i > tja.bpm[bp][0]) {
                                bpm = tja.bpm[bp][1];
                            }
                        }
                        for (var j = 0; j < bar.length; j++) {
                            if (bar[j] == "1" || bar[j] == "3") {
                                var circleGeometry = new THREE.CircleBufferGeometry(30, 32);
                                var redMaterial = new THREE.MeshBasicMaterial({
                                    color: 0xff0000
                                });
                                var circle = new THREE.Mesh(circleGeometry, redMaterial);
                                circle.position.y = i * backGround.speed + (j / bar
                                        .length) *
                                    backGround.speed;
                                backGround.scoreGroup.add(circle);
                                tja.judgeList.push([tja.judgeList.length, circle, bar[j], time]);
                            } else if (bar[j] == "2" || bar[j] == "4") {
                                var circleGeometry = new THREE.CircleBufferGeometry(30, 32);
                                var blueMaterial = new THREE.MeshBasicMaterial({
                                    color: 0x0000ff
                                });
                                var circle = new THREE.Mesh(circleGeometry, blueMaterial);
                                circle.position.y = i * backGround.speed + (j / bar
                                        .length) *
                                    backGround.speed;
                                backGround.scoreGroup.add(circle);
                                tja.judgeList.push([tja.judgeList.length, circle, bar[j], time]);
                            }
                            time += (60 / bpm) * beat / bar.length * 1000;
                        }
                    }
                    //tja.delayを戻す
                    for (var d = 0; d < tja.delay.length; d++) {
                        tja.delay[d][2] = 1;
                    }
                }
            });
        }
    }

    class BackGround {
        constructor() {
            //初期化
            this.width = window.innerWidth;
            this.height = window.innerHeight;
            this.speed = this.height; //譜面のスピードの基準
            this.renderer = new THREE.WebGLRenderer({
                canvas: document.querySelector('#myCanvas')
            });
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.setSize(this.width, this.height);
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(45, this.width / this.height);
            this.camera.position.set(0, 0, +1000);
            var MeshGeometry = new THREE.BoxBufferGeometry(this.width / 2, this.height, 1);
            var blackMaterial = new THREE.MeshBasicMaterial({
                color: 0x000000
            });
            this.leftMesh = new THREE.Mesh(MeshGeometry, blackMaterial);
            this.leftMesh.position.x = -this.width / 4;
            this.leftMesh.position.z = -10;
            this.scene.add(this.leftMesh);
            this.rightMesh = new THREE.Mesh(MeshGeometry, blackMaterial);
            this.rightMesh.position.x = this.width / 4;
            this.rightMesh.position.z = -10;
            this.scene.add(this.rightMesh);

            var lineMaterial = new THREE.LineBasicMaterial({
                color: 0x00ff00
            });
            var lineGeometry = new THREE.Geometry();
            lineGeometry.vertices.push(
                new THREE.Vector3(0, this.height, -9),
                new THREE.Vector3(0, -this.height, -9),
            );
            var line = new THREE.Line(lineGeometry, lineMaterial);
            this.scene.add(line);

            var torusGeometry = new THREE.TorusGeometry(40, 5, 64, 128);
            var torusMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ffff
            });
            this.torus = new THREE.Mesh(torusGeometry, torusMaterial);
            this.torus.position.y = -this.height / 4;
            this.scene.add(this.torus);

            var splineMaterial = new THREE.LineBasicMaterial({
                color: 0xffffff
            });
            var splineGeometry = new THREE.Geometry();
            this.splineObject = new THREE.Line(splineGeometry, splineMaterial);
            this.splineObject.position.x = -this.width / 2;
            this.splineObject.position.y = -this.height / 2;
            this.scene.add(this.splineObject);

            this.scoreGroup = new THREE.Object3D();
            this.scoreGroup.position.y = -this.height / 4;
            this.scene.add(this.scoreGroup);

            var loader = new THREE.FontLoader();
            loader.load("{% static 'aiBeats/typeface/helvetiker_regular.typeface.json' %}", function (font) {
                var textGeometry = new THREE.TextGeometry("", {
                    font: font,
                    size: 20,
                    height: 5,
                    curveSegments: 12
                });
                var materials = [
                    new THREE.MeshBasicMaterial({
                        color: 0x000000
                    }),
                    new THREE.MeshBasicMaterial({
                        color: 0x000000
                    })
                ];
                backGround.textMesh = new THREE.Mesh(textGeometry, materials);
                backGround.textMesh.position.y = -backGround.height / 4;
                backGround.textMesh.position.x = backGround.width / 20;
                backGround.scene.add(backGround.textMesh);
            });

            this.titleMesh = null; //初期化

            this.time = 0; //再生時間記録用

            //判定用の時間(±ミリ秒)
            this.bestTime = 34;
            this.goodTime = 117;
            this.missTime = 150;

            this.alreadyArray = []; //すでにたたいた音符

            this.renderer.render(this.scene, this.camera); // レンダリング
        }

        lineDraw(array) {
            var pointArray = [];
            for (var i = 0; i < sound.FFTSIZE / 2; i++) {
                var freqData = sound.freqByteData[i];
                if (!freqData) {
                    freqData = 0;
                } else {
                    freqData /= 512;
                }
                pointArray.push(new THREE.Vector2(i * this.width / (sound.FFTSIZE / 2), freqData * this.height));
            }
            var curve = new THREE.SplineCurve(pointArray);
            var points = curve.getPoints(500);
            var geometry = new THREE.BufferGeometry().setFromPoints(points);
            this.splineObject.geometry = geometry;
        }

        scoreDraw(time) { //time:曲の現在の時間
            var beatBar = 0;
            for (var i = 0; i < tja.beat.length; i++) {
                if (tja.currentBar > tja.beat[i][0]) {
                    beatBar = i;
                }
            }
            var bpmBar = 0;
            for (var i = 0; i < tja.bpm.length; i++) {
                if (tja.currentBar > tja.bpm[i][0]) {
                    bpmBar = i;
                }
            }
            var delay = 0;
            for (var i = 0; i < tja.delay.length; i++) {
                if (tja.currentBar > tja.delay[i][0] && tja.delay[i][2] != 0) {
                    delay = tja.delay[i][1];
                    tja.delay[i][2] = 0;
                    console.log(delay);
                }
            }
            tja.currentBar = tja.currentBar + (((time - this.time + delay * 1000) / 1000) * (tja.bpm[bpmBar][1] /
                60) / tja.beat[beatBar][1]);
            this.scoreGroup.position.y = this.scoreGroup.position.y - ((((time - this.time + delay * 1000) /
                1000 * (tja.bpm[bpmBar][1] / 60)) / tja.beat[beatBar][1]) * this.speed);
            this.time = time;
        }
        leftTouch() {
            var leftMeshMaterial = new THREE.MeshBasicMaterial({
                color: 0xff0000
            });
            this.leftMesh.material = leftMeshMaterial;
            this.renderer.render(this.scene, this.camera);
            setTimeout(function () {
                var blackMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000
                });
                backGround.leftMesh.material = blackMaterial;
                backGround.renderer.render(backGround.scene, backGround.camera);
            }, 50);
            leftSE.play();
            this.judge(sound.instance.position, 1);
        }
        rightTouch() {
            var rightMeshMaterial = new THREE.MeshBasicMaterial({
                color: 0x0000ff
            });
            this.rightMesh.material = rightMeshMaterial;
            this.renderer.render(this.scene, this.camera);
            setTimeout(function () {
                var blackMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000
                });
                backGround.rightMesh.material = blackMaterial;
                backGround.renderer.render(backGround.scene, backGround.camera);
            }, 50);
            rightSE.play();
            this.judge(sound.instance.position, 2);
        }

        judge(time, num) {
            var index = 0;
            var diff = [];
            $(tja.judgeList).each(function (i, val) {
                diff[i] = Math.abs(time - val[3]);
                index = (diff[index] < diff[i] || backGround.alreadyArray.includes(i)) ? index : i;
            });
            console.log(index, diff[index], this.alreadyArray);
            var judgeNum;
            if (tja.judgeList[index][2] == "1" || tja.judgeList[index][2] == "3") {
                judgeNum = 1;
            } else if (tja.judgeList[index][2] == "2" || tja.judgeList[index][2] == "4") {
                judgeNum = 2;
            }

            if (diff[index] <= this.bestTime && num == judgeNum) {
                this.alreadyArray.push(index);
                var blackMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000
                });
                tja.judgeList[index][1].material = blackMaterial;
                var judgeCtx = document.getElementById("judge").getContext("2d");

                judgeCtx.font = "40px 'ＭＳ Ｐゴシック'";
                judgeCtx.clearRect(0, 0, 200, 100);
                judgeCtx.fillStyle = "red";
                judgeCtx.fillText("Best!!", 50, 50);
                /*var loader = new THREE.FontLoader();
                loader.load("{% static 'aiBeats/typeface/helvetiker_regular.typeface.json' %}", function (font) {
                    var textGeometry = new THREE.TextGeometry("Best!!", {
                        font: font,
                        size: 20,
                        height: 5,
                        curveSegments: 12
                    });
                    var materials = [
                        new THREE.MeshBasicMaterial({
                            color: 0xff0000
                        }),
                        new THREE.MeshBasicMaterial({
                            color: 0x000000
                        })
                    ];
                    backGround.textMesh.geometry = textGeometry;
                    backGround.textMesh.material = materials;
                });*/
            } else if (diff[index] <= this.goodTime && diff[index] > this.bestTime && num == judgeNum) {
                this.alreadyArray.push(index);
                var blackMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000
                });
                tja.judgeList[index][1].material = blackMaterial;

                var judgeCtx = document.getElementById("judge").getContext("2d");
                judgeCtx.clearRect(0, 0, 200, 100);
                judgeCtx.font = "40px 'ＭＳ Ｐゴシック'";
                judgeCtx.fillStyle = "green";
                judgeCtx.fillText("Good!", 50, 50);
                /*var loader = new THREE.FontLoader();
                loader.load("{% static 'aiBeats/typeface/helvetiker_regular.typeface.json' %}", function (font) {
                    var textGeometry = new THREE.TextGeometry("Good!", {
                        font: font,
                        size: 20,
                        height: 5,
                        curveSegments: 12
                    });
                    var materials = [
                        new THREE.MeshBasicMaterial({
                            color: 0x00ff00
                        }),
                        new THREE.MeshBasicMaterial({
                            color: 0x000000
                        })
                    ];
                    backGround.textMesh.geometry = textGeometry;
                    backGround.textMesh.material = materials;
                });*/
            } else if (diff[index] <= this.missTime && (diff[index] > this.goodTime || num != judgeNum)) {
                this.alreadyArray.push(index);
                var blackMaterial = new THREE.MeshBasicMaterial({
                    color: 0x000000
                });
                tja.judgeList[index][1].material = blackMaterial;

                var judgeCtx = document.getElementById("judge").getContext("2d");
                judgeCtx.clearRect(0, 0, 200, 100);
                judgeCtx.font = "40px 'ＭＳ Ｐゴシック'";
                judgeCtx.fillStyle = "blue";
                judgeCtx.fillText("Miss", 50, 50);
                /*var loader = new THREE.FontLoader();
                loader.load("{% static 'aiBeats/typeface/helvetiker_regular.typeface.json' %}", function (font) {
                    var textGeometry = new THREE.TextGeometry("Miss", {
                        font: font,
                        size: 20,
                        height: 5,
                        curveSegments: 12
                    });
                    var materials = [
                        new THREE.MeshBasicMaterial({
                            color: 0x0000ff
                        }),
                        new THREE.MeshBasicMaterial({
                            color: 0x000000
                        })
                    ];
                    backGround.textMesh.geometry = textGeometry;
                    backGround.textMesh.material = materials;
                });*/
            } else {
                var judgeCtx = document.getElementById("judge").getContext("2d");
                judgeCtx.clearRect(0, 0, 200, 100);
                /*var loader = new THREE.FontLoader();
                loader.load("{% static 'aiBeats/typeface/helvetiker_regular.typeface.json' %}", function (font) {
                    var textGeometry = new THREE.TextGeometry("", {
                        font: font,
                        size: 20,
                        height: 5,
                        curveSegments: 12
                    });
                    var materials = [
                        new THREE.MeshBasicMaterial({
                            color: 0x000000
                        }),
                        new THREE.MeshBasicMaterial({
                            color: 0x000000
                        })
                    ];
                    backGround.textMesh.geometry = textGeometry;
                    backGround.textMesh.material = materials;
                });*/
            }
        }
    }
    //フルスクリーン化
    function ElementRequestFullscreen(element) {
        var list = [
            "requestFullscreen",
            "webkitRequestFullScreen",
            "mozRequestFullScreen",
            "msRequestFullscreen"
        ];
        var i;
        var num = list.length;
        for (i = 0; i < num; i++) {
            if (element[list[i]]) {
                element[list[i]]();
                return true;
            }
        }
        return false;
    }

    //フルスクリーン要素取得
    function DocumentGetFullscreenElement(document_obj) {
        return (
            document_obj.fullscreenElement ||
            document_obj.webkitFullscreenElement ||
            document_obj.mozFullScreenElement ||
            document_obj.msFullscreenElement ||
            null
        );
    }

    //フルスクリーン解除
    function DocumentExitFullscreen(document_obj) {
        var list = [
            "exitFullscreen",
            "webkitExitFullscreen",
            "mozCancelFullScreen",
            "msExitFullscreen"
        ];
        var i;
        var num = list.length;
        for (i = 0; i < num; i++) {
            if (document_obj[list[i]]) {
                document_obj[list[i]]();
                return true;
            }
        }
        return false;
    }

    function fullScreen() {
        if (DocumentGetFullscreenElement(document) == null) {
            var element = document.getElementById("wrap");
            ElementRequestFullscreen(element);
        } else {
            DocumentExitFullscreen(document);
        }
    }

    function pause() {
        if (sound.played == true) {
            if (sound.instance.paused == true) {
                document.getElementById("dropleft").className = "dropleft btn fas fa-pause";
                sound.instance.paused = false
            } else {
                document.getElementById("dropleft").className = "dropleft btn fas fa-play";
                sound.instance.paused = true;
            }
        }
    }

    function restart() {
        if (sound.played == true) {
            document.getElementById("dropleft").className = "dropleft btn fas fa-pause";
            sound.played = false;
            sound.instance.stop();
            backGround.alreadyArray = [];
            var redMaterial = new THREE.MeshBasicMaterial({
                color: 0xff0000
            });
            var blueMaterial = new THREE.MeshBasicMaterial({
                color: 0x0000ff
            });
            for (var i = 0; i < tja.judgeList.length; i++) {
                if (tja.judgeList[i][2] == "1" || tja.judgeList[i][2] == "3") {
                    tja.judgeList[i][1].material = redMaterial;
                } else if (tja.judgeList[i][2] == "2" || tja.judgeList[i][2] == "4") {
                    tja.judgeList[i][1].material = blueMaterial;
                }
            }
            $('.dropleft').dropdown('hide');
            setTimeout(function () {
                document.getElementById("dropleft").className = "dropleft btn fas fa-pause";
                sound.played = true;
                sound.instance.play();
            }, 2000);
        }
    }

    //効果音
    class SE {
        constructor(SOUND_ID, SOUND_PATH) {
            this.SOUND_ID = SOUND_ID;
            this.src = SOUND_PATH;
            createjs.Sound.registerSound({
                id: SOUND_ID,
                src: SOUND_PATH
            });
            this.volume = 1;
        }

        play() {
            var instance = createjs.Sound.createInstance(this.SOUND_ID);
            instance.volume = this.volume;
            instance.play({
                loop: 0
            });
        }

        changeVolume(v) {
            this.volume = v / 100;
        }
    }

    class Sound {
        constructor(SOUND_ID, SOUND_PATH) {
            this.SOUND_ID = SOUND_ID;
            this.src = SOUND_PATH;
            createjs.Sound.registerSound({
                id: SOUND_ID,
                src: SOUND_PATH
            });
            this.FFTSIZE = 64;
            this.freqByteData = new Uint8Array(this.FFTSIZE / 2);
            this.plugin = new createjs.WebAudioPlugin();
            this.context = this.plugin.context;
            this.analyserNode = this.context.createAnalyser();
            this.analyserNode.connect(this.context.destination);
            this.dynamicsNode = this.plugin.dynamicsCompressorNode;
            this.dynamicsNode.disconnect();
            this.dynamicsNode.connect(this.analyserNode);
            this.instance = createjs.Sound.createInstance(this.SOUND_ID);
            this.played = false; //再生開始したかどうか
        }

        play() {
            // 音楽再生
            this.instance.play({
                loop: 0
            });
            this.played = true;
            //オフセット処理
            backGround.time = -tja.offset * 1000;
            tja.currentBar = tja.offset * (tja.bpm[0][1] / 60) / 4 + 1;
            tick();

            // 毎フレーム時に実行されるループイベント
            function tick() {
                sound.analyserNode.getByteFrequencyData(sound.freqByteData);
                backGround.lineDraw(sound.freqByteData);
                backGround.scoreDraw(sound.instance.position);
                backGround.renderer.render(backGround.scene, backGround.camera); // レンダリング

                requestAnimationFrame(tick);
            }
        }

        changeVolume(v) {
            this.instance.volume = v / 100;
        }
    }

    function sound_play() {
        var button = document.getElementById("playButton");
        button.style.display = "none";
        sound.play();
    }
</script>
{% endblock %}